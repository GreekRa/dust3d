name: update-sponsors

on:
  schedule:
    - cron: "0 0 * * *" # Run every day at midnight
      branches:
        - master
  workflow_dispatch:

jobs:
  update-sponsors:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Fetch sponsors
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const query = `
              query {
              user(login: "huxingyi") {
                sponsorshipsAsMaintainer(first: 100) {
                  totalCount
                  nodes {
                    id
                    createdAt
                    tier {
                      name
                    }
                    sponsor {
                      login
                      avatarUrl
                    }
                  }
                }
              }
            }
            `;
            const response = await github.graphql(query);
            let html = '';
            for (const node of response.user.sponsorshipsAsMaintainer.nodes) {
                html += '<a href="' + node.sponsor.url + '" title="' + node.sponsor.login + (node.sponsor.name ? (' (' + node.sponsor.name + ')') : '') + '" target=_blank><image src="' + node.sponsor.avatarUrl + '" alt="@' + node.sponsor.login + '" width="35" height="35" style="border-radius: 17px;" /></a>\n';
            }
            if ('' !== html) {
                html = '## Sponsors  \n\n' + html + '\n _The list shown represent active sponsors on GitHub and a full list can be viewed at [SUPPORTERS](https://github.com/huxingyi/dust3d/blob/master/SUPPORTERS)._';
            }
            const fs = require('fs').promises;
            const readme = await fs.readFile('README.md', 'utf8');
            const beginString = '<!-- Sponsors begin -->';
            const endString = '<!-- Sponsors end -->';
            let startIndex = readme.indexOf(beginString);
            if (-1 !== startIndex) {
              startIndex = startIndex + beginString.length;
              const endIndex = readme.indexOf(endString);
              if (-1 !== endIndex) {
                const newContent = readme.substring(0, startIndex) + html + readme.substring(endIndex);
                await fs.writeFile('README.md', newContent);
              } else {
                throw new Error('Could not find end marker');
              }
            } else {
              throw new Error('Could not find begin marker');
            }
      - name: Upload README.md
        run: |
          if git diff --name-only HEAD | grep -q "README.md"; then
            git config --global user.email "${{ secrets.MY_EMAIL }}"
            git config --global user.name "huxingyi"
            git add README.md
            timestamp=$(TZ=":Australia/Sydney" date)
            git commit -m "Update sponsors ${timestamp}"
            git push origin HEAD
          fi